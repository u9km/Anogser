#import <Foundation/Foundation.h>
#import <UIKit/UIKit.h>
#include <mach-o/dyld.h>
#include <string.h>
#include <unistd.h> 
#include "dobby.h"

// 1. تعريف أوامر الباتش
const uint32_t NOP_HEX = 0xD503201F; 
const uint32_t RET_HEX = 0xD65F03C0; 

// 2. مصفوفة NOP (702 أوفست)
uintptr_t nop_offsets[] = {
    0x00004380, 0x00104D2C, 0x00104DBC, 0x00104DC8, 0x00104DD4, 0x00104E9C, 0x001050F8, 0x0010AEF0, 
    0x0010AF0C, 0x0010AF18, 0x0010B438, 0x0010B448, 0x0010C3B4, 0x0010C6A0, 0x0010DB68, 0x0010DE50, 
    0x0010EDD8, 0x0010F48C, 0x0010F648, 0x0010F9A4, 0x0010FEA4, 0x00110068, 0x00110564, 0x0011128C, 
    0x00111B38, 0x00111D38, 0x00111DFC, 0x00112DA8, 0x00113320, 0x001136BC, 0x0011374C, 0x001139EC, 
    0x00114DA4, 0x00115650, 0x00115920, 0x00116CAC, 0x00116FA8, 0x00118250, 0x00119F5C, 0x00119F7C, 
    0x0011A038, 0x0011A1D4, 0x0011B044, 0x0011C6B0, 0x0011C704, 0x0011CB58, 0x0011CBE4, 0x0011CC0C, 
    0x0011CC44, 0x0011CDF4, 0x0011CE98, 0x0011D4C0, 0x0011D4E4, 0x0011D5A4, 0x0011D5E8, 0x0011DDA4, 
    0x0011E3B4, 0x0011E4B0, 0x0011E5A0, 0x0011E638, 0x0011EA80, 0x0011ECC4, 0x0011EF78, 0x0011EFA0, 
    0x0011F0D8, 0x0011F214, 0x0011F658, 0x0011F6AC, 0x00120218, 0x00120404, 0x001204F0, 0x00120678, 
    0x00120730, 0x001207B4, 0x001207D4, 0x001208AC, 0x001210C8, 0x0012199C, 0x00121B10, 0x00121E0C, 
    0x00122FA0, 0x00123664, 0x00123B50, 0x00123E60, 0x00124DE0, 0x001250C8, 0x001251E8, 0x0012570C, 
    0x00125970, 0x00125B94, 0x00125F94, 0x00125FAC, 0x001262F8, 0x001264D4, 0x001266BC, 0x00126748, 
    0x001267D4, 0x00126948, 0x00126A30, 0x00126A48, 0x0012734C, 0x001275D8, 0x001275F0, 0x0012765C, 
    0x001276C0, 0x00127710, 0x0012774C, 0x00127828, 0x0012827C, 0x00128500, 0x00128598, 0x001285E0, 
    0x00128754, 0x001287BC, 0x001288B0, 0x00128A40, 0x00128AA8, 0x00128BDC, 0x00128C44, 0x001296EC, 
    0x00129724, 0x00129B9C, 0x00129BF8, 0x00129FAC, 0x0012A1E8, 0x001370A4, 0x001371F0, 0x001372AC, 
    0x001373F8, 0x00137624, 0x0013763C, 0x001376A0, 0x0013772C, 0x001377CC, 0x001378D0, 0x0013796C, 
    0x00137AA0, 0x00137B1C, 0x00137DF0, 0x00138168, 0x001382B4, 0x0013849C, 0x001385FC, 0x001386E8, 
    0x001388B8, 0x001388D4, 0x001388F8, 0x001389C8, 0x00138A3C, 0x00138C00, 0x00138CC8, 0x00139A74, 
    0x00139B60, 0x00139B70, 0x00139E58, 0x0013A0B4, 0x0013A1D8, 0x0013A234, 0x0013A294, 0x0013A460, 
    0x0013A498, 0x0013A560, 0x0013A598, 0x0013A65C, 0x0013A748, 0x0013A758, 0x0013A768, 0x0013A80C, 
    0x0013A854, 0x0013C370, 0x0013C654, 0x0013C818, 0x0013CC58, 0x0013CDC4, 0x0013DE94, 0x0013E150, 
    0x0013F094, 0x0013FE80, 0x00140104, 0x001402C8, 0x00140358, 0x001404E0, 0x00140528, 0x001405C8, 
    0x001405D8, 0x00140680, 0x00140854, 0x00140E10, 0x00140EE8, 0x00140EF4, 0x00141254, 0x00141264, 
    0x0014151C, 0x00141884, 0x00141AE0, 0x00141B0C, 0x00141C8C, 0x00141CB8, 0x00145EE8, 0x00146230, 
    0x00146544, 0x00146714, 0x00146754, 0x001468A4, 0x00146920, 0x00146964, 0x00146A68, 0x00146F34, 
    0x00147184, 0x001471B0, 0x001471D8, 0x00147468, 0x00147BF8, 0x00147C24, 0x00147D30, 0x00147D70, 
    0x001486CC, 0x001486EC, 0x00148720, 0x001487A8, 0x0014885C, 0x00148950, 0x00148998, 0x001489C8, 
    0x00148A1C, 0x00148A8C, 0x00148BA8, 0x00148C24, 0x00148C88, 0x00148CBC, 0x00148CD4, 0x00148D14, 
    0x00148D48, 0x00148D60, 0x0014A78C, 0x0014A898, 0x0014ABE8, 0x0014B038, 0x0014B054, 0x0014B33C, 
    0x0014B4D8, 0x0014B510, 0x0014B548, 0x0014B5D8, 0x0014B80C, 0x0014B958, 0x0014B96C, 0x0014CF88, 
    0x0014D0A4, 0x0014D900, 0x0014DB28, 0x0014DB60, 0x0014DE68, 0x0014E5B4, 0x0014E880, 0x0014EB68, 
    0x0014EC7C, 0x0014F164, 0x0014F21C, 0x0014F904, 0x0014F91C, 0x0014FBA0, 0x0014FC00, 0x0014FDD8, 
    0x0014FDF0, 0x0014FE3C, 0x0014FED0, 0x0015000C, 0x00150054, 0x00150438, 0x00150780, 0x001507F4, 
    0x00150AEC, 0x00150D70, 0x00150DB0, 0x00150E14, 0x00150E68, 0x001510E8, 0x0015112C, 0x00151514, 
    0x001517B0, 0x001518A8, 0x001519D0, 0x00151A9C, 0x00151D0C, 0x00151E4C, 0x00152144, 0x001527FC, 
    0x001528E8, 0x00152D58, 0x00152DB0, 0x00152F90, 0x001580F4, 0x0015839C, 0x0015917C, 0x0015929C, 
    0x00159694, 0x00159D18, 0x00159D74, 0x00159F9C, 0x0015A054, 0x0015A1A8, 0x0015A214, 0x0015A380, 
    0x0015A3E0, 0x0015A4A4, 0x0015A680, 0x0015AAD8, 0x0015AD40, 0x0015ADC0, 0x0015AE2C, 0x0015AE8C, 
    0x0015AEF8, 0x0015AF58, 0x0015AFC4, 0x0015B064, 0x0015B0C4, 0x0015B660, 0x0015B668, 0x0015B6AC, 
    0x0015B844, 0x0015B9F0, 0x0015BD40, 0x0015BD58, 0x0015BF68, 0x0015BFF8, 0x0015C0EC, 0x0015C26C, 
    0x0015C474, 0x0015C504, 0x0015C594, 0x0015C670, 0x0015C758, 0x0015C9D4, 0x0015D6C8, 0x0015DDEC, 
    0x0015E078, 0x0015E164, 0x0015F2B8, 0x0015F824, 0x0015F9C4, 0x0015FA34, 0x0015FB84, 0x0015FBF4, 
    0x0015FD8C, 0x0015FDB8, 0x00160118, 0x00160438, 0x001604FC, 0x00160E44, 0x00161018, 0x00161348, 
    0x00161754, 0x0016195C, 0x00161974, 0x001619AC, 0x001619F8, 0x001620BC, 0x00162764, 0x00162A68, 
    0x00162B18, 0x00162D1C, 0x00162E68, 0x00162F44, 0x00163028, 0x001635AC, 0x001639DC, 0x00163A9C, 
    0x00163D9C, 0x00163E3C, 0x001640FC, 0x00164188, 0x00164214, 0x001642FC, 0x001643DC, 0x00164410, 
    0x0016485C, 0x00164958, 0x00164D44, 0x00164E40, 0x001657FC, 0x00165C6C, 0x00165F14, 0x00165F90, 
    0x001692AC, 0x00169758, 0x001699D4, 0x0016AEA8, 0x0016AFC8, 0x0016B2F0, 0x0016B450, 0x0016B978, 
    0x0016BC08, 0x0016BDC0, 0x0016BEF8, 0x0016C030, 0x0016C76C, 0x0016CCD0, 0x0016CD20, 0x0016CD7C, 
    0x0016D050, 0x0016D1B8, 0x0016D250, 0x0016D344, 0x0016D4DC, 0x0016DF28, 0x0016E650, 0x0016E8CC, 
    0x0016F5F8, 0x0016F9B0, 0x0016FA20, 0x0016FF90, 0x001700A4, 0x0017017C, 0x00170210, 0x00170308, 
    0x00170F10, 0x0017115C, 0x00171E40, 0x00172420, 0x00172504, 0x001727C4, 0x00172830, 0x00172848, 
    0x001729B0, 0x00172E24, 0x00173C60, 0x00173EE0, 0x00174000, 0x00174014, 0x001743B0, 0x00174400, 
    0x00174880, 0x0017491C, 0x00174CE4, 0x0017508C, 0x001777B0, 0x00177A8C, 0x00177D48, 0x00178EFC, 
    0x001795B4, 0x001796A8, 0x0017979C, 0x0017A0F8, 0x0017A51C, 0x0017A7C4, 0x0017B354, 0x0017B4C8, 
    0x0017BAD8, 0x0017BC20, 0x0017BC74, 0x0017CCA4, 0x0017D0FC, 0x0017D3E4, 0x0017E2D4, 0x0017E404, 
    0x0017E424, 0x0017EF9C, 0x0017F244, 0x0017FFE0, 0x001803D4, 0x001803F0, 0x00180784, 0x001807BC, 
    0x001807D0, 0x001809F4, 0x00180BEC, 0x00180C78, 0x00180D04, 0x00180FF8, 0x00181044, 0x001811E4, 
    0x001813AC, 0x001817E8, 0x00181808, 0x00181930, 0x00181968, 0x00181FD8, 0x00182048, 0x00182364, 
    0x001831B4, 0x00184B24, 0x00184B38, 0x0018515C, 0x001851B8, 0x00185290, 0x00185770, 0x0018585C, 
    0x00185AE8, 0x00185E0C, 0x00185E14, 0x00185E58, 0x001862C8, 0x00186460, 0x001865F8, 0x0018694C, 
    0x00186C18, 0x00187410, 0x001876F8, 0x00189394, 0x00189600, 0x0018A9EC, 0x0018AAA0, 0x0018B31C, 
    0x0018B740, 0x0018B9E8, 0x0018E2DC, 0x0018E508, 0x0018EC40, 0x0018EFA4, 0x0018F948, 0x0018FFD4, 
    0x00190254, 0x001903E4, 0x0019080C, 0x00190C98, 0x001916B8, 0x001917C8, 0x00191FC0, 0x00192008, 
    0x001920D4, 0x00192108, 0x001922F4, 0x00192770, 0x0019295C, 0x00192AB0, 0x00192FE4, 0x00193268, 
    0x001933E8, 0x001937E8, 0x00193DA8, 0x00193E6C, 0x00193FB0, 0x0019445C, 0x00194814, 0x00194A30, 
    0x00194BB0, 0x00194D8C, 0x00194F4C, 0x00194F6C, 0x001952D8, 0x001952F8, 0x0019532C, 0x001955DC, 
    0x0019575C, 0x00195D1C, 0x001A1EE0, 0x001A1EF4, 0x001A1FE0, 0x001A1FF8, 0x001A2018, 0x001A20CC, 
    0x001A224C, 0x001A2264, 0x001A2284, 0x001A22E4, 0x001A2338, 0x001A2348, 0x001A2390, 0x001A2624, 
    0x001A2A8C, 0x001A2E84, 0x001A2EF4, 0x001A2FB4, 0x001A3030, 0x001A3108, 0x001A3114, 0x001A33C8, 
    0x001A33D8, 0x001A34D0, 0x001A35A8, 0x001A35B4, 0x001A3688, 0x001A36D8, 0x001A37B0, 0x001A37EC, 
    0x001A38AC, 0x001A392C, 0x001A39EC, 0x001A3AA0, 0x001A3E38, 0x001A3F1C, 0x001A3F54, 0x001A4020, 
    0x001A402C, 0x001A4144, 0x001A4150, 0x001A4220, 0x001A42F4, 0x001A43A0, 0x001A4504, 0x001A4740, 
    0x001A47B8, 0x001A47D8, 0x001A4850, 0x001A48B8, 0x001A49FC, 0x001A4A9C, 0x001A4AC8, 0x001A4B68, 
    0x001A4B94, 0x001A4CCC, 0x001A4CD8, 0x001A4D64, 0x001A4E24, 0x001A5000, 0x001A500C, 0x001A5110, 
    0x001A51E0, 0x001A5234, 0x001A5274, 0x001A52A0, 0x001A5404, 0x001A5490, 0x001A54F8, 0x001A562C, 
    0x001A5638, 0x001A5718, 0x001A5724, 0x001A57E4, 0x001A5960, 0x001A59BC, 0x001A5AAC, 0x001A5BEC, 
    0x001A6498, 0x001A65DC, 0x001A65E8, 0x001A66C8, 0x001A66D4, 0x001A6840, 0x001A697C, 0x001A6E38, 
    0x001A6E44, 0x001A6ED8, 0x001A6FC4, 0x001A6FD0, 0x001A7104, 0x001A7110, 0x001A71A8, 0x001A7298, 
    0x001A7338, 0x001A7344, 0x001A73EC, 0x001A7550, 0x001A7718, 0x001A7744, 0x001A7800, 0x001A78B4, 
    0x001A7C04, 0x001A8284, 0x001A86CC, 0x001A87DC, 0x001A8824, 0x001A88C0, 0x001A8ADC, 0x001A8D18, 
    0x001A8FC8, 0x001A8FD4, 0x001A9100, 0x001A910C, 0x001A9158, 0x001A9198, 0x001A91D8, 0x001B2148, 
    0x001B24D0, 0x001B28BC, 0x001B36DC, 0x001B3BBC, 0x001B4644, 0x001B48C0, 0x001B536C, 0x001B55E8, 
    0x001B62EC, 0x001B64A0, 0x001B6864, 0x001B692C, 0x001B6990, 0x001B6A74, 0x001B6AA8, 0x001B6B4C, 
    0x001B6C38, 0x001B6CC8, 0x001B6DA8, 0x001B6DE4, 0x001B6EC8, 0x001B6F90, 0x001B7078, 0x001B725C, 
    0x001B736C, 0x001B75B8, 0x001B75D4, 0x001B75F0, 0x001B7614, 0x001B7634, 0x001B7690, 0x001B789C, 
    0x001B7904, 0x001B7C4C, 0x001B7C88, 0x001B7CE0, 0x001B7D80, 0x001B80A0, 0x001B88F8, 0x001B9808, 
    0x001B98CC, 0x001B9AE8, 0x001BA130, 0x001BA174, 0x001BACBC, 0x001BB03C, 0x001BC2E0, 0x001BC3E8, 
    0x001C317C, 0x001C3244, 0x001C5794, 0x001C5824, 0x001CEF10, 0x001CF43C, 0x001CF844, 0x001D2694, 
    0x001D2704, 0x001D2800, 0x001D28D4, 0x001D29A8, 0x001D2DBC, 0x001D334C, 0x001D387C, 0x001D389C, 
    0x001D38D8, 0x001D397C, 0x001D39A8, 0x001EE45C, 0x001EE760, 0x001EED3C, 0x001EEDA8, 0x001F13D0, 
    0x001F147C, 0x001F169C, 0x001F2C34, 0x001F33E8, 0x001F3400, 0x00201204, 0x00201210, 0x002016EC, 
    0x00203AF8, 0x00203B10, 0x00206508, 0x0020654C, 0x0020BA90, 0x0020BAB0, 0x0020BAFC, 0x0020BB40, 
    0x0020C204, 0x0020E1A4, 0x002110DC, 0x0021157C, 0x00213F38, 0x00213FA4, 0x0021C488, 0x0021C4F0, 
    0x0021F438, 0x0022238C, 0x00222848, 0x00225274, 0x00225400, 0x0022546C, 0x00229898, 0x0022AD4C, 
    0x0022ADA4, 0x0022B238, 0x0022B28C, 0x0022B92C, 0x0022B978, 0x0022DE6C, 0x0022E1A8, 0x0023104C, 
    0x00231278, 0x002312DC, 0x002318D4, 0x00232EE0, 0x00232F34, 0x002333C0, 0x00233414, 0x00233A78, 
    0x00233AC8, 0x00235FF4, 0x00236330, 0x00239184, 0x002393B0, 0x00239414
};

// 3. مصفوفة RET (3 أوفستات)
uintptr_t ret_offsets[] = {
    0x000CC0FC, 0x000D22EC, 0x000ECE88
};

// 4. محرك الحقن المتدرج
void ExecutePatch(intptr_t slide) {
    size_t nop_count = sizeof(nop_offsets) / sizeof(nop_offsets[0]);
    size_t ret_count = sizeof(ret_offsets) / sizeof(ret_offsets[0]);

    // دفعات NOP: 50 أوفست كل ثانيتين
    for (size_t i = 0; i < nop_count; i++) {
        void* addr = (void*)(slide + nop_offsets[i]);
        DobbyCodePatch(addr, (uint8_t *)&NOP_HEX, 4);
        
        if ((i + 1) % 50 == 0) {
            NSLog(@"[BatchLog] Finished 50 offsets. Waiting 2 seconds...");
            sleep(2); 
        }
    }

    // دفعات RET
    for (size_t i = 0; i < ret_count; i++) {
        void* addr = (void*)(slide + ret_offsets[i]);
        DobbyCodePatch(addr, (uint8_t *)&RET_HEX, 4);
    }
}

// 5. المراقب الذكي
void on_image_added(const struct mach_header *mh, intptr_t slide) {
    for (uint32_t i = 0; i < _dyld_image_count(); i++) {
        if (_dyld_get_image_header(i) == mh) {
            const char *name = _dyld_get_image_name(i);
            if (name && strstr(name, "anogs")) {
                dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^{
                    ExecutePatch(slide);
                    
                    dispatch_async(dispatch_get_main_queue(), ^{
                        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"System" 
                                                                                       message:@"Bypass: Full Active ✅" 
                                                                                preferredStyle:UIAlertControllerStyleAlert];
                        [alert addAction:[UIAlertAction actionWithTitle:@"OK" style:UIAlertActionStyleDefault handler:nil]];
                        [[UIApplication sharedApplication].keyWindow.rootViewController presentViewController:alert animated:YES completion:nil];
                    });
                });
            }
            break;
        }
    }
}

__attribute__((constructor))
static void init() {
    _dyld_register_func_for_add_image(on_image_added);
}
