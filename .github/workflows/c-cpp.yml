name: Build Anogs Patcher Final Fix

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS Tweak
    runs-on: macos-latest

    steps:
      # 1. سحب الكود
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. إعداد Theos (بدون سكربت التثبيت لتجنب مشاكل API)
      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      # 3. تحميل SDKs (مع حذف المجلد القديم أولاً لحل مشكلة exit code 128)
      - name: Download iOS SDK
        run: |
          rm -rf $HOME/theos/sdks
          git clone --quiet --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          echo "SDKs Downloaded Successfully."

      # 4. التحقق من ملفات Dobby (تأكد أنك رفعت libdobby.a و dobby.h)
      - name: Verify Dobby Library
        run: |
          if [ ! -f ./libdobby.a ]; then
            echo "❌ Error: 'libdobby.a' is missing! Upload it to your repo."
            exit 1
          fi
          if [ ! -f ./dobby.h ]; then
            echo "❌ Error: 'dobby.h' is missing!"
            exit 1
          fi

      # 5. البناء
      - name: Compile Tweak
        run: |
          make clean
          make package FINALPACKAGE=1 messages=yes

      # 6. الرفع
      - name: Upload Dylib
        uses: actions/upload-artifact@v4
        with:
          name: Anogs_Patcher_Dylib
          path: .theos/obj/debug/*.dylib
          if-no-files-found: error
          compression-level: 0
