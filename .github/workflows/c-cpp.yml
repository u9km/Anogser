name: Build Anogs Patcher V4 Fix

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS Tweak
    runs-on: macos-latest

    steps:
      # 1. سحب الكود
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. إعداد Theos (الطريقة اليدوية المضمونة)
      # تم استبدال curl بـ git clone لتجنب خطأ api.github.com
      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      # 3. تحميل SDKs
      - name: Download iOS SDK
        run: |
          git clone --quiet --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          echo "SDKs Downloaded Successfully."

      # 4. التحقق من وجود مكتبة Dobby
      - name: Verify Dobby Library
        run: |
          if [ ! -f ./libdobby.a ]; then
            echo "❌ Error: 'libdobby.a' is missing!"
            echo "Please upload libdobby.a to your repository root."
            exit 1
          fi
          if [ ! -f ./dobby.h ]; then
            echo "❌ Error: 'dobby.h' is missing!"
            exit 1
          fi
          echo "✅ Dobby library found."

      # 5. البناء
      - name: Compile Tweak
        run: |
          make clean
          make package FINALPACKAGE=1 messages=yes

      # 6. الرفع
      - name: Upload Dylib
        uses: actions/upload-artifact@v4
        with:
          name: Anogs_Patcher_Dylib
          path: .theos/obj/debug/*.dylib
          if-no-files-found: error
          compression-level: 0
